rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null; // Allow reading other users for friend features
      
      // Allow user stats subcollections
      match /stats/{statId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Allow game history subcollections
      match /gameHistory/{gameId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Achievement Definitions - Read-only for all authenticated users
    match /achievementDefinitions/{achievementId} {
      allow read: if request.auth != null;
      allow write: if false; // Only admin can write
    }

    // User Achievements - users can read/write their own achievements
    match /userAchievements/{achievementId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Achievement Progress - users can read/write their own progress
    match /achievementProgress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User Achievement Progress (subcollection)
    match /users/{userId}/achievementProgress/{progressId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Achievement Notifications - users can read/write their own notifications
    match /achievementNotifications/{notificationId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // User Notifications (subcollection)
    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Daily/Hourly Metrics for achievement tracking
    match /dailyMetrics/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /hourlyMetrics/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Daily and hourly metrics with date patterns (userId_date format)
    match /dailyMetrics/{metricId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    match /hourlyMetrics/{metricId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Friend Stats for achievements
    match /friendStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // User Achievements (legacy path)
    match /users/{userId}/achievements/{achievementId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Friends System - Temporary permissive rules for development
    match /friends/{friendshipId} {
      allow read, write: if request.auth != null; // Simplified for development
    }

    match /friendRequests/{requestId} {
      allow read, write: if request.auth != null; // Simplified for development
    }

    match /gameInvitations/{invitationId} {
      allow read, write: if request.auth != null; // Simplified for development
    }

    match /presence/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Game Modes - Read-only for all authenticated users
    match /gameModes/{modeId} {
      allow read: if request.auth != null;
      allow write: if false; // Only admin can write
    }

    // Games
    match /games/{gameId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.players;
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.players;
    }
    
    // Users can read and write waiting room documents
    match /waitingroom/{roomId} {
      allow read, write: if request.auth != null;
    }
    
    // Users can read and write matches they are part of
    match /matches/{matchId} {
      allow read, write: if request.auth != null;
    }
    
    // Completed matches - users can read completed matches they were part of
    match /completedMatches/{matchId} {
      allow read, write: if request.auth != null;
    }
    
    // Match archives - for storing historical match data
    match /matchArchives/{matchId} {
      allow read, write: if request.auth != null;
    }
    
    // User game statistics and counters
    match /userStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User leaderboard statistics
    match /userLeaderboardStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Daily game counters and statistics
    match /dailyStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Hourly game tracking for streaks
    match /hourlyStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User friends and friend statistics
    match /friendStats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Users can read and write their own inventory items
    match /inventory/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow reading of public game data (backgrounds, items, etc.)
    match /backgrounds/{backgroundId} {
      allow read: if true;
    }
    
    match /items/{itemId} {
      allow read: if true;
    }
    
    // Users can read and write game sessions they are part of
    match /gameSessions/{sessionId} {
      allow read, write: if request.auth != null;
    }
    
    // Leaderboards - read for all authenticated users, write only by system
    match /leaderboards/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Only server-side operations should write leaderboards
    }
    
    // Statistics - read for all authenticated users
    match /statistics/{document=**} {
      allow read: if request.auth != null;
    }
  }
}
